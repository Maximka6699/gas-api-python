# Gas-api-python

### Что использовалась для разработки API?

Для разработки использовались библиотеки **FastApi, SQL Alchemy**.
В качестве БД я использовал **PostgreSQL** для хранения и управления данными. Так же я использовал **PGadmin4** для удобного использования PostgreSQL.
Для CRUD запросов использовал расширение Postman для VScode. Там можно будет собрать свою коллекцию запросов для каждой сущности, чтобы ускорить работу с API вручную.

### Краткая информация о приложении.

Это приложение, реализующее Api для сети АЗС. С помощью него можно:

- Создать нового пользователя с набором следующих параметров: **username, password, email, role, loyaltylvl, score, regdate, reviews.**
  - username - проверяется на уникальность, длинна должна быть >3 и <50 символов.
  - email - проверяется на уникальность и правильность доменного имени.
  - password - должен быть длиннее 8 символов и при попадании в бд шифруется.
  - regdate - ставится автоматически.
  - reviews - отзывы подтягивается из одноименной сущности. При создании пользователя отзывов у него нет.
  - role - по умолчанию "user", но если пользователя создаёт админе, то роль может быть назначена "admin", что даст доступ ко всем возможностям Api.
- Создавать, изменять, удалять объекты сущностей Gas, Review, FDU, Fuel, User.

### Установка

1. Клонируйте реапозиторий к себе на Пк командой `git clone https://github.com/Maximka6699/gas-api-python.git`
2. Установите зависимости командой `pip install -r requirements.txt`
   Базу данных для теста API на гитхаб выгружу в ближайшее время, а пока что придётся наполнить БД своими данными.
3. Далее надо будет запустить PGadmin4 и создать там пустую базу данных. Далее подключите свою БД в этом поле файла database.py: `DATABASE_URL = "postgresql://postgres(user):1111(password)@localhost:5432(адрес и порт на котором работает постгрес)/gas(название бд)"
4. Теперь можно приступать к запуску приложения. Запустить можно в одном из 2-х режимов:
   1. запуск приложения `python -m uvicorn app.main:app --reload `
   2. запуск приложения в режиме отладки `python -m uvicorn app.main:app --reload --log-level debug` нужно для расширенных логов ошибки 500 (ошибка сервера)

### Пример использования приложения

#### Создание пользователя и получение токена.

Первым делом нам надо будет создать пользователя. Можно создать как админа, так и обычного пользователя. Создавать можно двумя способами: 1) Через PGadmin4; 2) Через POST-запрос.

1. **Создание пользователя через запрос:**
   Команда `http://localhost:8000/create-user/` типа POST с телом запроса как на картинке: ![[Pasted image 20241022130940.png]]
2. **Получение токена с помощью username+password:**
   Команда для его получения: `http://localhost:8000/token`. Тело запроса как на картинке, только с вашими данными.
   ![[Pasted image 20241022131245.png]]
   После того как получили токен передаем его в поле Authorization. В токене хранится информация о пользователе и его роли, с помощью него в путях запроса проверяется роль пользователя и в зависимости от неё выдается доступ к функциям. Т.Е. если ваша роль не Администратор, то вы сможете только просматривать некоторую информацию о сущностях, и изменить некоторые из своих данных, тогда как админу будет доступен весь функционал.
   **Примеры ограничения доступа:**
   Обычному пользователю запрещено просматривать информацию о всех пользователях, удалять других пользователей и тп. ![[Pasted image 20241022112031.png]]![[Pasted image 20241022112237.png]]
   Если же вы забыли получить токен, то доступа к функциям у вас не будет, так как вы не авторизовались. ![[Pasted image 20241022132123.png]]
3. **Финал:**
   После того как вы создали пользователя и получили токен, можно использовать приложение! **Токен действителен в течении 1200 минут.** При желании можно увеличить или уменьшить время действия токена.

#### Запросы к FUEL(топливо)

1. Просмотр всего топлива: запрос - `http://localhost:8000/fuels`
   ![[Pasted image 20241022133837.png]]
2. Просмотр конкретного топлива: запрос - `http://localhost:8000/fuels/13`
   ![[Pasted image 20241022134128.png]]
3. Добавление топлива:
   1. Добавление без прикрепления к ТРК: POST-запрос `http://localhost:8000/fuels/add/` с телом
      ![[Pasted image 20241022134333.png]]
   2. Добавление с прикреплением с ТРК: POST-запрос `http://localhost:8000/fuels/add/` с телом
      ![[Pasted image 20241022145840.png]]
   3. Обновление данных о топливе: PUT-запрос `http://localhost:8000/fuels/12` с телом как на картинке. Кроме цены и ТРК в которых есть топливо можно менять название топлива.
      ![[Pasted image 20241022151148.png]]
   4. Удаление топлива: DELETE-запрос `http://localhost:8000/fuels/delete` с телом как на картинке. Можно удалять несколько видов топлива за раз, либо одно.
      ![[Pasted image 20241022151521.png]]

Все GET & DEL запросы похожи по сути между собой, так что описывать их не буду. Опишу только GET запрос на просмотр всех элементов сразу, PUT запрос на обновление объекта и POST запрос на его обновление.

#### Запросы к FDU(ТРК - колонка с топливом.)

service_date проставляется автоматически.

1. Просмотр всех ТРК: запрос - `http://localhost:8000/fdus/`
   ![[Pasted image 20241022152753.png]]
2. Добавление ТРК:
   1. POST-запрос `http://localhost:8000/fdus/add/` с телом. так же можно добавлять без прикрепления к заправке и сделать это позже с помощью PUT запроса.
      ![[Pasted image 20241022152825.png]]
3. Обновление данных о ТРК: PUT-запрос `http://localhost:8000/fdus/16` с телом как на картинке.
   ![[Pasted image 20241022153119.png]]

#### Запросы к GAS(заправка)

1. Просмотр всех Заправок: запрос - `http://localhost:8000/gases/`
   ![[Pasted image 20241022153427.png]]
2. Добавление Заправки:
   1. POST-запрос `http://localhost:8000/gases/add/` с телом. Адрес указывать обязательно, а вот фото и ТРК можно будет прикрепить позже. Так же можно добавить и все нужные поля за раз.
      ![[Pasted image 20241022153954.png]]
3. Обновление данных о ТРК: PUT-запрос `http://localhost:8000/gases/4` с телом как на картинке.
   ![[Pasted image 20241022154257.png]]

#### Запросы к Review(Отзывы)

1. Получить отзывы можно 3-мя способами:
   - get reviews by gas id: запрос - `http://localhost:8000/gases/2/reviews`
     отзыв для заправки 2 ![[Pasted image 20241022154751.png]]
   - get reviews by id: запрос - `http://localhost:8000/reviews/1`
     получение отзыва по id отзыва ![[Pasted image 20241022154838.png]]
   - get all reviews: запрос - `http://localhost:8000/reviews/`
     ![[Pasted image 20241022155012.png]]
2. Добавление отзыва:
   1. POST-запрос `http://localhost:8000/reviews/add/5` с телом.
      ![[Pasted image 20241022155116.png]]
3. Обновление данных об отзыве: PUT-запрос `http://localhost:8000/reviews/1` с телом как на картинке.
   ![[Pasted image 20241022155212.png]]

#### Пользователь и админ.

1. Запрос по которому можно узнать админ ты или нет - GET запрос `http://localhost:8000/admin/`
   - не авторизован ![[Pasted image 20241022162100.png]]
   - админ ![[Pasted image 20241022162450.png]]
   - пользователь ![[Pasted image 20241022162709.png]]
2. Получение всех пользователей, запрос может выполнить только админ. GET-запрос - `http://localhost:8000/admin/users/` ![[Pasted image 20241022162909.png]]
3. Получение пользователя по id. GET-запрос - `http://localhost:8000/admin/users/5` ![[Pasted image 20241022163821.png]]
4. Получение информации о себе. GET-запрос - `http://localhost:8000/users/me/`
   1. админ ![[Pasted image 20241022164013.png]]
   2. пользователь ![[Pasted image 20241022164611.png]]
5. Обновление информации о себе:
   Можно изменить Имя пользователя, пароль (понадобится старый пароль), почту. ![[Pasted image 20241022165343.png]]
